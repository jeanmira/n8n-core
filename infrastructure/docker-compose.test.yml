# n8n Test Environment
version: '3.8'

services:
  postgres-test:
    image: postgres:15-alpine
    container_name: n8n-postgres-test
    environment:
      POSTGRES_USER: n8n_test
      POSTGRES_PASSWORD: test_password
      POSTGRES_DB: n8n_test
    tmpfs:
      - /var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U n8n_test"]
      interval: 5s
      timeout: 3s
      retries: 5

  n8n-test:
    build:
      context: ..
      dockerfile: infrastructure/Dockerfile
    container_name: n8n-test
    environment:
      # Database
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres-test
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: n8n_test
      DB_POSTGRESDB_USER: n8n_test
      DB_POSTGRESDB_PASSWORD: test_password

      # n8n Configuration
      N8N_BASIC_AUTH_ACTIVE: false
      N8N_HOST: localhost
      N8N_PORT: 5678
      N8N_PROTOCOL: http

      # Execution
      EXECUTIONS_PROCESS: main
      EXECUTIONS_TIMEOUT: 60
      EXECUTIONS_TIMEOUT_MAX: 120

      # Timezone
      GENERIC_TIMEZONE: UTC
      TZ: UTC

      # Logging
      N8N_LOG_LEVEL: debug
      N8N_LOG_OUTPUT: console

      # Custom nodes
      N8N_CUSTOM_EXTENSIONS: /home/node/.n8n/custom

    volumes:
      - ../workflows:/home/node/.n8n/workflows:ro
      - ../custom-nodes:/home/node/.n8n/custom:ro
      - ../tests:/home/node/.n8n/tests:ro
    depends_on:
      postgres-test:
        condition: service_healthy
    command: ["n8n"]

networks:
  default:
    name: n8n-test-network
